#include "block.h"

#include "matrix.h"
#include "util.h"

int is_plant(int w) {
    return w > 16;
}

int is_obstacle(int w) {
    return w != BLOCK_EMPTY && w < 16;
}

int is_destructable(int w) {
    return w != BLOCK_EMPTY && w != BLOCK_CLOUD;
}

int is_transparent(int w) {
    return w == BLOCK_EMPTY || w == BLOCK_GLASS || w == BLOCK_LEAVES || is_plant(w);
}

void make_plant(float *vertex, float *normal, float *texture,
                float x, float y, float z, float n, int w, float rotation) {
    float *v = vertex;
    float *d = normal;
    float *t = texture;
    float s = 0.0625;
    float a = 0;
    float b = s;
    float du, dv;
    w--;
    du = (w % 16) * s;
    dv = (w / 16 * 3) * s;
    // left
    *(v++) = x;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x;
    *(v++) = y + n;
    *(v++) = z + n;
    *(v++) = x;
    *(v++) = y + n;
    *(v++) = z - n;
    *(v++) = x;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x;
    *(v++) = y - n;
    *(v++) = z + n;
    *(v++) = x;
    *(v++) = y + n;
    *(v++) = z + n;
    *(d++) = -1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = -1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = -1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = -1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = -1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = -1;
    *(d++) = 0;
    *(d++) = 0;
    *(t++) = a + du;
    *(t++) = a + dv;
    *(t++) = b + du;
    *(t++) = b + dv;
    *(t++) = a + du;
    *(t++) = b + dv;
    *(t++) = a + du;
    *(t++) = a + dv;
    *(t++) = b + du;
    *(t++) = a + dv;
    *(t++) = b + du;
    *(t++) = b + dv;
    // right
    *(v++) = x;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x;
    *(v++) = y + n;
    *(v++) = z + n;
    *(v++) = x;
    *(v++) = y - n;
    *(v++) = z + n;
    *(v++) = x;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x;
    *(v++) = y + n;
    *(v++) = z - n;
    *(v++) = x;
    *(v++) = y + n;
    *(v++) = z + n;
    *(d++) = 1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = 1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = 1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = 1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = 1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = 1;
    *(d++) = 0;
    *(d++) = 0;
    *(t++) = b + du;
    *(t++) = a + dv;
    *(t++) = a + du;
    *(t++) = b + dv;
    *(t++) = a + du;
    *(t++) = a + dv;
    *(t++) = b + du;
    *(t++) = a + dv;
    *(t++) = b + du;
    *(t++) = b + dv;
    *(t++) = a + du;
    *(t++) = b + dv;
    // front
    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z;
    *(v++) = x + n;
    *(v++) = y - n;
    *(v++) = z;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z;
    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z;
    *(v++) = x - n;
    *(v++) = y + n;
    *(v++) = z;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = -1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = -1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = -1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = -1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = -1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = -1;
    *(t++) = b + du;
    *(t++) = a + dv;
    *(t++) = a + du;
    *(t++) = a + dv;
    *(t++) = a + du;
    *(t++) = b + dv;
    *(t++) = b + du;
    *(t++) = a + dv;
    *(t++) = a + du;
    *(t++) = b + dv;
    *(t++) = b + du;
    *(t++) = b + dv;
    // back
    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z;
    *(v++) = x + n;
    *(v++) = y - n;
    *(v++) = z;
    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z;
    *(v++) = x - n;
    *(v++) = y + n;
    *(v++) = z;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = 1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = 1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = 1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = 1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = 1;
    *(d++) = 0;
    *(d++) = 0;
    *(d++) = 1;
    *(t++) = a + du;
    *(t++) = a + dv;
    *(t++) = b + du;
    *(t++) = b + dv;
    *(t++) = b + du;
    *(t++) = a + dv;
    *(t++) = a + du;
    *(t++) = a + dv;
    *(t++) = a + du;
    *(t++) = b + dv;
    *(t++) = b + du;
    *(t++) = b + dv;
    // rotate the plant
    float mat[16];
    float vec[4] = {0};
    matrix_rotate(mat, 0, 1, 0, RADIANS(rotation));
    for (int i = 0; i < 24; i++) {
        // vertex
        v = vertex + i * 3;
        vec[0] = *(v++) - x;
        vec[1] = *(v++) - y;
        vec[2] = *(v++) - z;
        vector_multiply(vec, mat, vec);
        v = vertex + i * 3;
        *(v++) = vec[0] + x;
        *(v++) = vec[1] + y;
        *(v++) = vec[2] + z;
        // normal
        d = normal + i * 3;
        vec[0] = *(d++);
        vec[1] = *(d++);
        vec[2] = *(d++);
        vector_multiply(vec, mat, vec);
        d = normal + i * 3;
        *(d++) = vec[0];
        *(d++) = vec[1];
        *(d++) = vec[2];
    }
}

void make_cube(
        float *vertex, float *normal, float *texture,
        int left, int right, int top, int bottom, int front, int back,
        float x, float y, float z, float n, int w) {
    float *v = vertex;
    float *d = normal;
    float *t = texture;
    float s = 0.0625;
    float a = 0;
    float b = s;
    float du, dv;
    float ou, ov;
    w--;
    ou = (w % 16) * s;
    ov = (w / 16 * 3) * s;
    if (left) {
        du = ou;
        dv = ov + s;
        *(v++) = x - n;
        *(v++) = y - n;
        *(v++) = z - n;
        *(v++) = x - n;
        *(v++) = y + n;
        *(v++) = z + n;
        *(v++) = x - n;
        *(v++) = y + n;
        *(v++) = z - n;
        *(v++) = x - n;
        *(v++) = y - n;
        *(v++) = z - n;
        *(v++) = x - n;
        *(v++) = y - n;
        *(v++) = z + n;
        *(v++) = x - n;
        *(v++) = y + n;
        *(v++) = z + n;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(t++) = a + du;
        *(t++) = a + dv;
        *(t++) = b + du;
        *(t++) = b + dv;
        *(t++) = a + du;
        *(t++) = b + dv;
        *(t++) = a + du;
        *(t++) = a + dv;
        *(t++) = b + du;
        *(t++) = a + dv;
        *(t++) = b + du;
        *(t++) = b + dv;
    }
    if (right) {
        du = ou;
        dv = ov + s;
        *(v++) = x + n;
        *(v++) = y - n;
        *(v++) = z - n;
        *(v++) = x + n;
        *(v++) = y + n;
        *(v++) = z + n;
        *(v++) = x + n;
        *(v++) = y - n;
        *(v++) = z + n;
        *(v++) = x + n;
        *(v++) = y - n;
        *(v++) = z - n;
        *(v++) = x + n;
        *(v++) = y + n;
        *(v++) = z - n;
        *(v++) = x + n;
        *(v++) = y + n;
        *(v++) = z + n;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(t++) = b + du;
        *(t++) = a + dv;
        *(t++) = a + du;
        *(t++) = b + dv;
        *(t++) = a + du;
        *(t++) = a + dv;
        *(t++) = b + du;
        *(t++) = a + dv;
        *(t++) = b + du;
        *(t++) = b + dv;
        *(t++) = a + du;
        *(t++) = b + dv;
    }
    if (top) {
        du = ou;
        dv = ov + s + s;
        *(v++) = x - n;
        *(v++) = y + n;
        *(v++) = z - n;
        *(v++) = x - n;
        *(v++) = y + n;
        *(v++) = z + n;
        *(v++) = x + n;
        *(v++) = y + n;
        *(v++) = z + n;
        *(v++) = x - n;
        *(v++) = y + n;
        *(v++) = z - n;
        *(v++) = x + n;
        *(v++) = y + n;
        *(v++) = z + n;
        *(v++) = x + n;
        *(v++) = y + n;
        *(v++) = z - n;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(t++) = a + du;
        *(t++) = b + dv;
        *(t++) = a + du;
        *(t++) = a + dv;
        *(t++) = b + du;
        *(t++) = a + dv;
        *(t++) = a + du;
        *(t++) = b + dv;
        *(t++) = b + du;
        *(t++) = a + dv;
        *(t++) = b + du;
        *(t++) = b + dv;
    }
    if (bottom) {
        du = ou;
        dv = ov + 0;
        *(v++) = x - n;
        *(v++) = y - n;
        *(v++) = z - n;
        *(v++) = x + n;
        *(v++) = y - n;
        *(v++) = z - n;
        *(v++) = x + n;
        *(v++) = y - n;
        *(v++) = z + n;
        *(v++) = x - n;
        *(v++) = y - n;
        *(v++) = z - n;
        *(v++) = x + n;
        *(v++) = y - n;
        *(v++) = z + n;
        *(v++) = x - n;
        *(v++) = y - n;
        *(v++) = z + n;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(t++) = a + du;
        *(t++) = a + dv;
        *(t++) = b + du;
        *(t++) = a + dv;
        *(t++) = b + du;
        *(t++) = b + dv;
        *(t++) = a + du;
        *(t++) = a + dv;
        *(t++) = b + du;
        *(t++) = b + dv;
        *(t++) = a + du;
        *(t++) = b + dv;
    }
    if (front) {
        du = ou;
        dv = ov + s;
        *(v++) = x - n;
        *(v++) = y - n;
        *(v++) = z + n;
        *(v++) = x + n;
        *(v++) = y - n;
        *(v++) = z + n;
        *(v++) = x + n;
        *(v++) = y + n;
        *(v++) = z + n;
        *(v++) = x - n;
        *(v++) = y - n;
        *(v++) = z + n;
        *(v++) = x + n;
        *(v++) = y + n;
        *(v++) = z + n;
        *(v++) = x - n;
        *(v++) = y + n;
        *(v++) = z + n;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = -1;
        *(t++) = b + du;
        *(t++) = a + dv;
        *(t++) = a + du;
        *(t++) = a + dv;
        *(t++) = a + du;
        *(t++) = b + dv;
        *(t++) = b + du;
        *(t++) = a + dv;
        *(t++) = a + du;
        *(t++) = b + dv;
        *(t++) = b + du;
        *(t++) = b + dv;
    }
    if (back) {
        du = ou;
        dv = ov + s;
        *(v++) = x - n;
        *(v++) = y - n;
        *(v++) = z - n;
        *(v++) = x + n;
        *(v++) = y + n;
        *(v++) = z - n;
        *(v++) = x + n;
        *(v++) = y - n;
        *(v++) = z - n;
        *(v++) = x - n;
        *(v++) = y - n;
        *(v++) = z - n;
        *(v++) = x - n;
        *(v++) = y + n;
        *(v++) = z - n;
        *(v++) = x + n;
        *(v++) = y + n;
        *(v++) = z - n;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(d++) = 0;
        *(d++) = 0;
        *(d++) = 1;
        *(t++) = a + du;
        *(t++) = a + dv;
        *(t++) = b + du;
        *(t++) = b + dv;
        *(t++) = b + du;
        *(t++) = a + dv;
        *(t++) = a + du;
        *(t++) = a + dv;
        *(t++) = a + du;
        *(t++) = b + dv;
        *(t++) = b + du;
        *(t++) = b + dv;
    }
}

void make_cube_wireframe(float *vertex, float x, float y, float z, float n) {
    float *v = vertex;
    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z + n;
    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z + n;
    *(v++) = x - n;
    *(v++) = y + n;
    *(v++) = z + n;
    *(v++) = x - n;
    *(v++) = y + n;
    *(v++) = z + n;
    *(v++) = x - n;
    *(v++) = y + n;
    *(v++) = z - n;
    *(v++) = x - n;
    *(v++) = y + n;
    *(v++) = z - n;
    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x + n;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x + n;
    *(v++) = y - n;
    *(v++) = z + n;
    *(v++) = x + n;
    *(v++) = y - n;
    *(v++) = z + n;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z + n;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z + n;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z - n;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z - n;
    *(v++) = x + n;
    *(v++) = y - n;
    *(v++) = z - n;

    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z + n;
    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z + n;
    *(v++) = x + n;
    *(v++) = y - n;
    *(v++) = z + n;
    *(v++) = x + n;
    *(v++) = y - n;
    *(v++) = z + n;
    *(v++) = x + n;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x + n;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x - n;
    *(v++) = y + n;
    *(v++) = z - n;
    *(v++) = x - n;
    *(v++) = y + n;
    *(v++) = z + n;
    *(v++) = x - n;
    *(v++) = y + n;
    *(v++) = z + n;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z + n;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z + n;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z - n;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z - n;
    *(v++) = x - n;
    *(v++) = y + n;
    *(v++) = z - n;

    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x - n;
    *(v++) = y + n;
    *(v++) = z - n;
    *(v++) = x - n;
    *(v++) = y + n;
    *(v++) = z - n;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z - n;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z - n;
    *(v++) = x + n;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x + n;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z - n;
    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z + n;
    *(v++) = x - n;
    *(v++) = y + n;
    *(v++) = z + n;
    *(v++) = x - n;
    *(v++) = y + n;
    *(v++) = z + n;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z + n;
    *(v++) = x + n;
    *(v++) = y + n;
    *(v++) = z + n;
    *(v++) = x + n;
    *(v++) = y - n;
    *(v++) = z + n;
    *(v++) = x + n;
    *(v++) = y - n;
    *(v++) = z + n;
    *(v++) = x - n;
    *(v++) = y - n;
    *(v++) = z + n;
}