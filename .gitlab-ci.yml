stages:
    - build
    - test

variables:
    MAVEN_REPO_PATH: "$CI_PROJECT_PATH/.m2/repository"
    MAVEN_OPTS: "-Dmaven.repo.local=$MAVEN_REPO_PATH"

cache:
    paths:
        - $MAVEN_REPO_PATH/

# Сборка и тестирование C-модуля

build-c:
    stage: build
    script:
        - mkdir -p game/build
        - cd game/build
        - cmake ..
        - cmake --build .
    artifacts:
        paths:
            - game/build/
        expire_in: 1 week
    only:
        changes:
            - game/**/*

test-c:
    stage: test
    script:
        - cd game/build
        - ctest --verbose
    artifacts:
        paths:
            - game/build/
        expire_in: 1 week
    only:
        changes:
            - game/**/*

# Сборка и тестирование Java-модуля

build-java:
    stage: build
    script:
        - mvn compile $MAVEN_OPTS
    artifacts:
        paths:
            - blockchain/target/
            - game-integration/target/
            - start-menu/target/
        expire_in: 1 week
    only:
        changes:
            - blockchain/**/*
            - game-integration/**/*
            - start-menu/**/*

test-java:
    stage: test
    script:
        - mvn install $MAVEN_OPTS
    artifacts:
        paths:
            - blockchain/target/
            - game-integration/target/
            - start-menu/target/
        expire_in: 1 week
    only:
        changes:
            - blockchain/**/*
            - game-integration/**/*
            - start-menu/**/*
